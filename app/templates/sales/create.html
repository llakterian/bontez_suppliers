{% extends "base.html" %}

{% block title %}Create Sale - Bontez Suppliers{% endblock %}

{% block extra_css %}
<style>
    .item-row {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        background-color: #f9f9f9;
    }
    .remove-item-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<h2>Create New Sale</h2>

<form method="POST" class="form" id="saleForm">
    <h3>Customer Information</h3>
    <div class="form-group">
        <label for="client_id">Client</label>
        <select id="client_id" name="client_id" required>
            <option value="">-- Select Client --</option>
            {% for client in clients %}
                <option value="{{ client.id }}">{{ client.name }} ({{ client.phone }})</option>
            {% endfor %}
        </select>
    </div>
    
    <h3>Supplier Information</h3>
    <div class="form-group">
        <label for="supplier_id">Primary Supplier (optional)</label>
        <select id="supplier_id" name="supplier_id">
            <option value="">-- Mixed Gas --</option>
            {% for supplier in suppliers %}
                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <h3>Items</h3>
    <div id="itemsContainer">
        <div class="item-row">
            <div class="form-group">
                <label>Product</label>
                <select name="item_product_id" class="item-product">
                    <option value="">-- Select Product --</option>
                    {% for product in products %}
                        <option value="{{ product.id }}" data-price="{{ product.price }}">
                            {{ product.name }} - KES {{ "{:.2f}".format(product.price) }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Quantity</label>
                <input type="number" name="item_quantity" value="1" min="1" class="item-quantity">
            </div>
            <button type="button" class="remove-item-btn" onclick="removeItem(this)">Remove</button>
        </div>
    </div>
    <button type="button" class="btn btn-secondary" onclick="addItem()">Add Another Item</button>
    
    <h3>Payment Method</h3>
    <div class="form-group">
        <label for="payment_method">Payment Method</label>
        <select id="payment_method" name="payment_method" required onchange="updatePaymentFields()">
            <option value="">-- Select Payment Method --</option>
            <option value="cash">Cash</option>
            <option value="mpesa">Mpesa</option>
            <option value="installment">Installment</option>
        </select>
    </div>
    
    <div id="mpesaField" style="display:none;">
        <div class="form-group">
            <label for="mpesa_code">Mpesa Transaction Code</label>
            <input type="text" id="mpesa_code" name="mpesa_code" placeholder="e.g. ABC123DEF">
        </div>
    </div>
    
    <div id="installmentField" style="display:none;">
        <div class="form-group">
            <label for="num_installments">Number of Installments</label>
            <select id="num_installments" name="num_installments">
                <option value="2">2 Installments</option>
                <option value="3" selected>3 Installments</option>
                <option value="4">4 Installments</option>
                <option value="6">6 Installments</option>
            </select>
        </div>
    </div>
    
    <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" rows="3"></textarea>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Sale</button>
        <a href="{{ url_for('sales.list_sales') }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
function addItem() {
    const container = document.getElementById('itemsContainer');
    const newRow = document.createElement('div');
    newRow.className = 'item-row';
    newRow.innerHTML = `
        <div class="form-group">
            <label>Product</label>
            <select name="item_product_id" class="item-product">
                <option value="">-- Select Product --</option>
                {% for product in products %}
                    <option value="{{ product.id }}" data-price="{{ product.price }}">
                        {{ product.name }} - KES {{ "{:.2f}".format(product.price) }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Quantity</label>
            <input type="number" name="item_quantity" value="1" min="1" class="item-quantity">
        </div>
        <button type="button" class="remove-item-btn" onclick="removeItem(this)">Remove</button>
    `;
    container.appendChild(newRow);
}

function removeItem(btn) {
    btn.parentElement.remove();
}

function updatePaymentFields() {
    const method = document.getElementById('payment_method').value;
    document.getElementById('mpesaField').style.display = method === 'mpesa' ? 'block' : 'none';
    document.getElementById('installmentField').style.display = method === 'installment' ? 'block' : 'none';
}
</script>
{% endblock %}
