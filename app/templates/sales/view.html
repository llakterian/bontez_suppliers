{% extends "base.html" %}

{% block title %}Sale #{{ sale.id }} - Bontez Suppliers{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2>Sale Transaction #{{ sale.id }}</h2>
    <a href="{{ url_for('sales.list_sales') }}" class="btn btn-secondary">Back to Sales</a>
</div>

<div class="sale-details">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px;">
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Transaction Date</p>
            <p style="margin-bottom: 0;"><strong>{{ sale.sale_date.strftime('%B %d, %Y at %H:%M') }}</strong></p>
        </div>
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Customer</p>
            <p style="margin-bottom: 0;"><strong><a href="{{ url_for('clients.view_client', client_id=sale.client_id) }}" style="color: var(--primary); text-decoration: none;">{{ sale.client.name }}</a></strong></p>
        </div>
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Supplier</p>
            <p style="margin-bottom: 0;"><strong>{{ sale.supplier.name if sale.supplier else 'Mixed Gas' }}</strong></p>
        </div>
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Payment Method</p>
            <p style="margin-bottom: 0;"><strong>{{ sale.payment_method.upper() }}</strong></p>
        </div>
    </div>
    
    {% if sale.mpesa_code %}
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
        <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Mpesa Transaction Code</p>
        <p style="margin-bottom: 0;"><strong>{{ sale.mpesa_code }}</strong></p>
    </div>
    {% endif %}
    
    {% if sale.notes %}
    <div style="margin-top: 12px; padding: 12px; background: var(--light); border-radius: 8px;">
        <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Notes</p>
        <p style="margin-bottom: 0;">{{ sale.notes }}</p>
    </div>
    {% endif %}
</div>

<h3 style="margin-top: 36px;">Items Purchased</h3>
{% if sale.items %}
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in sale.items %}
                <tr>
                    <td><strong>{{ item.product.name }}</strong></td>
                    <td>{{ item.quantity }}</td>
                    <td>KES {{ "{:,.2f}".format(item.unit_price) }}</td>
                    <td><strong>KES {{ "{:,.2f}".format(item.subtotal) }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}

<div class="sale-summary">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Total Amount</p>
            <p style="font-size: 24px; font-weight: 700; margin-bottom: 0; color: var(--primary);">KES {{ "{:,.2f}".format(sale.total_amount) }}</p>
        </div>
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Amount Paid</p>
            <p style="font-size: 24px; font-weight: 700; margin-bottom: 0; color: var(--success);">KES {{ "{:,.2f}".format(sale.amount_paid) }}</p>
        </div>
        <div>
            <p style="color: #6c757d; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Remaining Balance</p>
            <p style="font-size: 24px; font-weight: 700; margin-bottom: 0; color: {% if sale.remaining_balance() == 0 %}var(--success){% else %}var(--warning){% endif %};">KES {{ "{:,.2f}".format(sale.remaining_balance()) }}</p>
        </div>
    </div>
</div>

{% if sale.payment_method == 'installment' %}
<h3 style="margin-top: 36px;">Installment Schedule</h3>
{% if sale.installments %}
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Due Date</th>
                    <th>Paid Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for installment in sale.installments %}
                <tr>
                    <td><strong>KES {{ "{:,.2f}".format(installment.amount) }}</strong></td>
                    <td>{{ installment.due_date.strftime('%b %d, %Y') }}</td>
                    <td>{{ installment.paid_date.strftime('%b %d, %Y') if installment.paid_date else 'â€”' }}</td>
                    <td>
                        {% if installment.is_paid %}
                            <span style="padding: 4px 8px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 12px; font-weight: 600;">Paid</span>
                        {% else %}
                            <span style="padding: 4px 8px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 12px; font-weight: 600;">Pending</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}

{% if sale.remaining_balance() > 0 %}
<form method="POST" action="{{ url_for('sales.add_installment', sale_id=sale.id) }}" class="form" style="max-width: 400px;">
    <h3 style="color: var(--primary);">Record Installment Payment</h3>
    <div class="form-group">
        <label for="amount">Payment Amount (Max: KES {{ "{:,.2f}".format(sale.remaining_balance()) }}) <span style="color: var(--danger);">*</span></label>
        <input type="number" id="amount" name="amount" step="0.01" max="{{ sale.remaining_balance() }}" required placeholder="e.g. 2000">
    </div>
    <button type="submit" class="btn btn-primary">Record Payment</button>
</form>
{% endif %}
{% endif %}

<div class="actions">
    <a href="{{ url_for('sales.list_sales') }}" class="btn btn-secondary">Back to Sales</a>
</div>
{% endblock %}
