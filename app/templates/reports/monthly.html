{% extends "base.html" %}

{% block title %}Monthly Report - Bontez Suppliers{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        margin-bottom: 20px;
    }
    .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .chart-wrapper {
        background-color: white;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .chart-title {
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
    }
    canvas {
        max-width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<h2>Monthly Sales Report</h2>

<div class="report-header">
    <form method="GET" style="display: inline;">
        <select name="month" required>
            <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
            <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
            <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
            <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
            <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
            <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
            <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
            <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
            <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
            <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
            <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
            <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
        </select>
        <select name="year" required>
            <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
            <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
            <option value="2026" {% if year == 2026 %}selected{% endif %}>2026</option>
        </select>
        <button type="submit" class="btn btn-primary">Load Report</button>
    </form>
    <p>Period: <strong>{{ "%s %d"|format(['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][month-1], year) }}</strong></p>
</div>

<div class="charts-container">
    <div class="chart-wrapper">
        <div class="chart-title">Sales by Supplier (Bar Chart)</div>
        <canvas id="barChart"></canvas>
    </div>
    <div class="chart-wrapper">
        <div class="chart-title">Sales Distribution (Pie Chart)</div>
        <canvas id="pieChart"></canvas>
    </div>
</div>

<div class="summary-section">
    <h3>Summary</h3>
    <div id="summaryContent">
        <p>Loading summary...</p>
    </div>
</div>

<div class="actions">
    <a href="{{ url_for('reports.daily_report') }}" class="btn btn-primary">View Daily Report</a>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const year = {{ year }};
    const month = {{ month }};
    
    fetch('/reports/monthly-data?year=' + year + '&month=' + month)
        .then(response => response.json())
        .then(data => {
            const colors = data.colors;
            const labels = data.labels;
            const salesData = data.data;
            const totalRevenue = data.total_revenue;
            
            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales Amount (KES)',
                        data: salesData,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (KES)'
                            }
                        }
                    }
                }
            });
            
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: salesData,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            const summaryHtml = '<p><strong>Total Monthly Revenue:</strong> KES ' + totalRevenue.toFixed(2) + '</p>' +
                               '<p><strong>Number of Suppliers:</strong> ' + labels.length + '</p>';
            document.getElementById('summaryContent').innerHTML = summaryHtml;
        });
});
</script>
{% endblock %}
